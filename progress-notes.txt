# Code Review Fix Progress

Branch: fix/code-review-20260127-155450
Created: 2026-01-27 15:54
Main branch: major/pi-brain

## Issues to Fix

### P2 Issues (Will Fix)

1. **src/daemon/processor.ts:749-754** - Missing prompt file error loses diagnostic information
   - When prompt file access check fails, EnvironmentValidationResult only indicates `valid: false` with empty `missingSkills`
   - Need to add `missingPromptFile?: boolean` or `reason?: string` field for better diagnostics

2. **src/daemon/worker.ts:193-203** - Idle loop blocks stop() for up to 30 seconds
   - Worker idle re-check loop sleeps for 30 seconds between checks
   - If stop() is called during this sleep, worker won't exit until sleep completes
   - Need interruptible wait pattern (shorter intervals or signal-based)

### P3 Issues (Ignored per instructions)

- package.json `copy-assets` script not portable to Windows
- vite.config.ts proxy only active in dev mode

---

---

## 2026-01-27 16:05 - Task 14.5 (Frontend Graceful API Failure Handling)

**Status**: pending â†’ done
**Validation**: 
- `npm run check` passes (lint + format)
- `npm test -- --run` passes (1198 tests)
- `svelte-check` passes (0 errors)
- Frontend correctly handles: network errors, non-JSON responses, timeouts

**Commit**: 17a82cc

**Changes**:
- `src/web/app/src/lib/api/client.ts`:
  - Added content-type checking before JSON parsing
  - Added `createNetworkError()` and `createContentTypeError()` factories
  - Added `isBackendOffline()` and `getErrorMessage()` helpers
  - Exported all new utilities

- Updated all route pages to use new error utilities:
  - `+page.svelte` (dashboard)
  - `sessions/+page.svelte`
  - `search/+page.svelte`
  - `settings/+page.svelte`
  - `decisions/+page.svelte`
  - `prompt-learning/+page.svelte`
  - `nodes/[id]/+page.svelte`

- Updated stores and components:
  - `lib/stores/nodes.ts`
  - `lib/components/dashboard/abandoned-restarts.svelte`
  - `lib/components/dashboard/daemon-decisions.svelte`
  - `lib/components/dashboard/news-feed.svelte`

**Result**: When backend is offline, users now see actionable messages like:
  "Backend is offline. Start the daemon with 'pi-brain daemon start'."
  instead of cryptic JSON parsing errors.

---

## 2026-01-27 16:11 - Code Review Fixes (Task 14.5)

**Status**: done
**Validation**: 
- `npm test -- --run` passes (1198 tests)
- `svelte-check` passes
- Verified removal of brittle browser checks

**Commit**: b27afa6

**Changes**:
- `src/web/app/src/lib/api/client.ts`: Removed `error.message.includes("fetch")` check, now catches all TypeErrors as network errors in that block.
- `src/web/app/src/routes/+page.svelte`: Simplified catch block since API errors are handled by `Promise.allSettled`.

**Notes**: Addressed P2 and P3 issues from code review.
