# Code Review Fix Progress

Branch: fix/code-review-20260127-155450
Created: 2026-01-27 15:54
Main branch: major/pi-brain

## Issues to Fix

### P2 Issues (Will Fix)

1. **src/daemon/processor.ts:749-754** - Missing prompt file error loses diagnostic information
   - When prompt file access check fails, EnvironmentValidationResult only indicates `valid: false` with empty `missingSkills`
   - Need to add `missingPromptFile?: boolean` or `reason?: string` field for better diagnostics

2. **src/daemon/worker.ts:193-203** - Idle loop blocks stop() for up to 30 seconds
   - Worker idle re-check loop sleeps for 30 seconds between checks
   - If stop() is called during this sleep, worker won't exit until sleep completes
   - Need interruptible wait pattern (shorter intervals or signal-based)

### P3 Issues (Ignored per instructions)

- package.json `copy-assets` script not portable to Windows
- vite.config.ts proxy only active in dev mode

---

---

## 2026-01-27 16:05 - Task 14.5 (Frontend Graceful API Failure Handling)

**Status**: pending → done
**Validation**: 
- `npm run check` passes (lint + format)
- `npm test -- --run` passes (1198 tests)
- `svelte-check` passes (0 errors)
- Frontend correctly handles: network errors, non-JSON responses, timeouts

**Commit**: 17a82cc

**Changes**:
- `src/web/app/src/lib/api/client.ts`:
  - Added content-type checking before JSON parsing
  - Added `createNetworkError()` and `createContentTypeError()` factories
  - Added `isBackendOffline()` and `getErrorMessage()` helpers
  - Exported all new utilities

- Updated all route pages to use new error utilities:
  - `+page.svelte` (dashboard)
  - `sessions/+page.svelte`
  - `search/+page.svelte`
  - `settings/+page.svelte`
  - `decisions/+page.svelte`
  - `prompt-learning/+page.svelte`
  - `nodes/[id]/+page.svelte`

- Updated stores and components:
  - `lib/stores/nodes.ts`
  - `lib/components/dashboard/abandoned-restarts.svelte`
  - `lib/components/dashboard/daemon-decisions.svelte`
  - `lib/components/dashboard/news-feed.svelte`

**Result**: When backend is offline, users now see actionable messages like:
  "Backend is offline. Start the daemon with 'pi-brain daemon start'."
  instead of cryptic JSON parsing errors.

---

## 2026-01-27 16:11 - Code Review Fixes (Task 14.5)

**Status**: done
**Validation**: 
- `npm test -- --run` passes (1198 tests)
- `svelte-check` passes
- Verified removal of brittle browser checks

**Commit**: b27afa6

**Changes**:
- `src/web/app/src/lib/api/client.ts`: Removed `error.message.includes("fetch")` check, now catches all TypeErrors as network errors in that block.
- `src/web/app/src/routes/+page.svelte`: Simplified catch block since API errors are handled by `Promise.allSettled`.

**Notes**: Addressed P2 and P3 issues from code review.

---

## 2026-01-27 16:47 - Integration Repair Plan Verification

**Status**: ALL TASKS COMPLETE ✅
**Validation**: Full verification of all checklist items

**Verified:**
- 2.1 Build Pipeline: `npm run build` creates `dist/migrations/` with 11 SQL files
- 2.2 Worker Initialization: Daemon starts without crashing
- 2.3 Non-Fatal Environment Validation: Worker idles gracefully when skills missing
- 2.4 Frontend Error Handling: Graceful API failure handling (completed in earlier commit 17a82cc)
- 2.5 Vite Proxy: Frontend correctly proxies `/api/*` to backend on port 8765
- 2.6 RLM Skill: User configuration issue - worker idles with warning message

**Health check**: `curl http://localhost:8765/health` → `{"status":"ok",...}`
**Proxy test**: `curl http://localhost:5173/api/v1/stats` → `{"status":"success",...}`

**Notes**: All integration issues identified in the repair plan have been addressed.
The rlm skill installation (2.6) is a user configuration task, not a code fix.
The daemon gracefully degrades when skills are missing.

**Update**: Fixed rlm skill symlink
- Removed broken `~/skills/rlm` (only had README.md)
- Created symlink: `~/skills/rlm` → `~/projects/pi-rlm/skills/rlm`
- Daemon now finds rlm skill and processes sessions without warnings

---

## 2026-01-27 17:04 - Task 13.6 (Extract quirk-repository.ts)

**Status**: pending → done
**Validation**: 
- `npm run check` passes (lint + format)
- `npm test -- --run` passes (1198 tests)
- Verified exports work correctly via index.ts

**Commit**: 6f53c5e

**Changes**:
- Created `src/storage/quirk-repository.ts` (~314 lines)
- Extracted quirk query functions: `listQuirks`, `getQuirksByModel`, `countQuirks`, `getAllQuirkModels`, `getAggregatedQuirks`, `getNodeQuirks`
- Extracted quirk types: `QuirkFrequency`, `QuirkSeverity`, `ListQuirksFilters`, `ListQuirksOptions`, `QuirkResult`, `ListQuirksResult`, `ModelQuirkStats`, `QuirksByModelResult`
- Added re-exports in `node-repository.ts` for backward compatibility
- Added export in `src/storage/index.ts`
- Reduced `node-repository.ts` from 2099 to 1811 lines (288 lines removed)

**Notes**: Part of Phase 13 refactoring - extracting modules from monolithic node-repository.ts.
