# Code Review Fix Progress

Branch: fix/code-review-20260127-092619
Created: 2026-01-27 09:26
Main branch: major/pi-brain

## Issues to Fix

1. [P2] src/storage/node-repository.ts:234-268 - UPDATE statement missing source fields
   - upsertNode UPDATE doesn't update session_file, segment_start, segment_end, computer
   - These are intentionally immutable (ID is deterministic from these values)
   - Add comment explaining why they're omitted

2. [P3] src/storage/node-repository.ts:269-274 - Repeated db.prepare calls
   - DELETE statements call db.prepare() separately for each table
   - Cache these prepared statements like insertTag/insertTopic

3. [P3] src/storage/node-types.ts:38-42 - Input encoding not normalized
   - Uses ":" as separator which could theoretically collide
   - Use length-prefix encoding for robustness

---

## 2026-01-27 09:27 - Task 1.1, 1.2, 1.3

**Status**: pending â†’ done (all three tasks)
**Validation**:
- Task 1.1: Comment added at src/storage/node-repository.ts:235-237 explaining why source fields (session_file, segment_start, segment_end, computer) are omitted from UPDATE statement
- Task 1.2: DELETE statements now prepared into named variables (deleteTags, deleteTopics, deleteLessons, deleteModelQuirks, deleteToolErrors, deleteDaemonDecisions) before execution at lines 275-293
- Task 1.3: Length-prefix encoding implemented in generateDeterministicNodeId() at src/storage/node-types.ts:48 using format "len:value|len:value|len:value"
- All 1167 tests pass
- npm run check passes
**Commit**: 294c730
**Notes**:
- All three code review issues were addressed in a single commit
- TASKS.md status corrected to reflect completed work
