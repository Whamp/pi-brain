# Code Review Fix Progress

Branch: fix/code-review-20260127-211938
Created: 2026-01-27 21:19
Main branch: major/pi-brain

## Issues to Fix

1. [P2] Nodes with empty decisions/lessons perpetually re-embedded
2. [P3] Test doesn't verify embedding regeneration  
3. [P3] Tests rely on implicit test.json absence

---

## Progress Log


---

## 2026-01-27 21:30 - Task 17.3.1

**Status**: pending → done
**Validation**: 
  - 11 new unit tests for storage functions (storeEmbeddingWithVec, deleteEmbedding, getEmbedding, hasEmbedding, serializeEmbedding, deserializeEmbedding)
  - Tests cover: basic storage, upsert semantics, vec table updates with correct dimensions, dimension mismatch handling
  - All 1255 tests pass
**Commit**: 64435dcc
**Notes**: Added storeEmbeddingWithVec helper function to embedding-utils.ts:
  - Stores embeddings in both node_embeddings (binary blob) and node_embeddings_vec (vec0 virtual table)
  - Handles upsert semantics (INSERT OR REPLACE)
  - Gracefully handles dimension mismatch (stores in node_embeddings, skips vec table)
  - Uses BigInt for vec table rowid as required by sqlite-vec
  - Also added getEmbedding, hasEmbedding, deleteEmbedding helper functions
  - Added serializeEmbedding/deserializeEmbedding for binary blob conversion

---

## 2026-01-27 21:38 - Task 17.3.2

**Status**: pending → done
**Validation**: 
  - 4 new unit tests for embedding provider initialization in worker
  - Tests cover: missing API key warning, successful initialization log, skipped initialization when not configured, hasEmbedding utility
  - All 1259 tests pass
**Commit**: ba8bf99f
**Notes**: Added embedding generation at node ingest time in worker.ts:
  - Initialize embedding provider during worker startup (if configured)
  - Generate embeddings after node creation using buildEmbeddingText (rich format with summary + decisions + lessons)
  - Store using storeEmbeddingWithVec (both node_embeddings table and vec0 virtual table)
  - Handle failures gracefully (log warning, don't fail job) - backfill job will catch gaps
  - API key validation on startup with appropriate warning messages
